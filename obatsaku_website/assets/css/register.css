<?php
session_start();
include "db/koneksi.php";

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $username = htmlspecialchars(trim($_POST['username']));
    $email = htmlspecialchars(trim($_POST['email']));
    $nama_depan = htmlspecialchars(trim($_POST['nama_depan']));
    $nama_belakang = htmlspecialchars(trim($_POST['nama_belakang']));
    $no_hp = htmlspecialchars(trim($_POST['no_hp']));
    $password = htmlspecialchars(trim($_POST['password']));
    $tipe_pengguna = $_POST['tipe_pengguna'];
    $status_akun = $_POST['status_akun'];

    // Cek apakah username sudah ada
    $cek_user = mysqli_query($conn, "SELECT * FROM pengguna WHERE username = '$username'");
    if (mysqli_num_rows($cek_user) > 0) {
        $error = "Username sudah digunakan!";
    } else {
        // Upload foto
        $foto_profil = "";
        if ($_FILES['foto_profil']['name'] != "") {
            $foto_name = $_FILES['foto_profil']['name'];
            $foto_tmp = $_FILES['foto_profil']['tmp_name'];
            $foto_path = "uploads/" . basename($foto_name);

            if (move_uploaded_file($foto_tmp, $foto_path)) {
                $foto_profil = $foto_path;
            } else {
                $error = "Gagal mengupload foto profil!";
            }
        }

        // Jika tidak ada error, simpan data
        if (!isset($error)) {
            $query = "INSERT INTO pengguna 
                (username, email, nama_depan, nama_belakang, no_hp, password, foto_profil, tipe_pengguna, status_akun)
                VALUES 
                ('$username', '$email', '$nama_depan', '$nama_belakang', '$no_hp', '$password', '$foto_profil', '$tipe_pengguna', '$status_akun')";

            if (mysqli_query($conn, $query)) {
                // Registrasi berhasil, bisa redirect atau beri pesan
                header("Location: login.php?success=1");
                exit;
            } else {
                $error = "Gagal menyimpan data ke database!";
            }
        }
    }
}
?>
